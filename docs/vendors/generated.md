# Thingpress for Generated Certificates

This document describes how to use Thingpress with certificates generated by the `generate_certificates.py` script.

## Overview

The Generated Certificates Provider is a Lambda function that processes certificate files created by the `generate_certificates.py` script and forwards them to the Thingpress bulk importer. This provider enables you to import certificates that were generated programmatically rather than from hardware secure elements.

## Prerequisites

1. An AWS account with permissions to create Lambda functions, SQS queues, and S3 buckets
2. The AWS CLI or AWS SAM CLI installed and configured
3. Python 3.9 or later

## Setup

### 1. Generate Certificates

Use the `generate_certificates.py` script to generate certificates:

```bash
python script/generate_certificates.py --count 100 --output-dir ./output
```

This will create certificate files in the specified output directory.

### 2. Deploy the CloudFormation Stack

Deploy the CloudFormation template using the AWS SAM CLI:

```bash
sam deploy --template-file templates/provider_generated.yaml \
  --stack-name thingpress-provider-generated \
  --parameter-overrides \
    TargetQueueUrl=<your-bulk-importer-queue-url> \
    S3BucketName=<your-s3-bucket-name> \
    S3NotificationPrefix=certificates/
```

Replace the placeholder values with your actual configuration.

### 3. Upload Certificate Files

Upload the generated certificate files to the S3 bucket with the specified prefix:

```bash
aws s3 cp output/certificates_*.txt s3://<your-s3-bucket-name>/certificates/
```

## How It Works

1. When a certificate file is uploaded to the S3 bucket with the specified prefix, an S3 event notification is sent to the SQS queue.
2. The Lambda function processes the SQS messages, retrieves the certificate files from S3, and processes each certificate.
3. For each certificate:
   - The Common Name (CN) is extracted from the certificate to use as the Thing name
   - The certificate and Thing name are forwarded to the bulk importer queue
4. The bulk importer processes the certificates and creates the corresponding AWS IoT resources.

## Certificate Format

The certificate files should contain one base64-encoded certificate per line. Each certificate should include its full chain (end-entity certificate + intermediate CA + root CA).

This is the default output format of the `generate_certificates.py` script.

## Troubleshooting

### Common Issues

1. **Certificate Processing Failures**:
   - Check the Lambda function logs in CloudWatch Logs
   - Verify that the certificates are properly base64-encoded
   - Ensure the certificates include a valid Common Name (CN)

2. **S3 Event Notification Issues**:
   - Verify that the S3 bucket notification configuration is correct
   - Check that the uploaded files have the correct prefix

3. **Permission Issues**:
   - Ensure the Lambda function has the necessary permissions to read from S3 and send messages to SQS

### Monitoring

Monitor the following resources:

- Lambda function execution logs in CloudWatch Logs
- SQS queue metrics (ApproximateNumberOfMessages, ApproximateNumberOfMessagesNotVisible)
- Dead Letter Queue (DLQ) for failed processing

## Advanced Configuration

### Custom Thing Names

By default, the provider uses the Common Name (CN) from the certificate as the Thing name. If you need custom Thing names, you can modify the `extract_common_name` function in the Lambda code.

### Batch Processing

The Lambda function processes certificates in batches. You can adjust the batch size by modifying the `BatchSize` parameter in the CloudFormation template.

### Error Handling

Failed certificate processing attempts are sent to a Dead Letter Queue (DLQ) after three retries. You can monitor this queue to identify and resolve issues.
